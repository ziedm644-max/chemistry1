<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>الامتحانات</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .exam-question { margin-bottom: 1.5rem; }
    .exam-question label { display: block; margin: 0.3rem 0; cursor: pointer; }
    .submit-btn {
      padding: 0.8rem 2rem;
      background: #6366f1;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1rem;
      transition: 0.3s;
    }
    .submit-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 18px rgba(0,0,0,.4);
    }
    .timer { font-weight: bold; margin-bottom: 1rem; font-size: 1.2rem; }
  </style>
</head>
<body>

<header>الامتحانات</header>

<main class="page-content">
  <div class="timer" id="timer">الوقت المتبقي: </div>

  <form id="exam-form">
    <div class="exam-question">
      <p>1. ما هو لون السماء؟</p>
      <label><input type="radio" name="q1" value="0"> أحمر</label>
      <label><input type="radio" name="q1" value="1"> أزرق</label>
      <label><input type="radio" name="q1" value="0"> أخضر</label>
    </div>

    <div class="exam-question">
      <p>2. ما هي عاصمة مصر؟</p>
      <label><input type="radio" name="q2" value="0"> الإسكندرية</label>
      <label><input type="radio" name="q2" value="1"> القاهرة</label>
      <label><input type="radio" name="q2" value="0"> أسوان</label>
    </div>

    <div class="exam-question">
      <p>3. 2 + 2 = ؟</p>
      <label><input type="radio" name="q3" value="0"> 3</label>
      <label><input type="radio" name="q3" value="1"> 4</label>
      <label><input type="radio" name="q3" value="0"> 5</label>
    </div>

    <button type="submit" class="submit-btn">تسليم الامتحان</button>
  </form>
</main>

<script>
const code = localStorage.getItem("ziadUserCode");
const users = {
  "111111": { name: "أحمد علي",   isTeacher: false },
  "222222": { name: "محمد أسامة", isTeacher: false },
  "333333": { name: "عمر ربيع",   isTeacher: false },
  "999999": { name: "Ziad Mohsen", isTeacher: true  }
};

if(!code || !users[code]) { window.location.href = "index.html"; }
const currentUser = users[code];
if(currentUser.isTeacher) { window.location.href = "dashboard.html"; }

// مدة الامتحان بالثواني (مثال 5 دقائق = 300 ثانية)
const examDuration = 5 * 60;
let remainingTime = examDuration;

// جلب حالة الامتحان من localStorage
let examData = JSON.parse(localStorage.getItem("examData") || "{}");

// منع دخول الامتحان أكثر من مرة
if(examData[currentUser.name]?.taken){
  alert("لقد أنهيت الامتحان بالفعل، لا يمكنك الدخول مرة أخرى!");
  window.location.href = "dashboard.html";
}

// تخزين بداية الامتحان وفتح القفل
if(!examData[currentUser.name]){
  examData[currentUser.name] = { taken: false, startTime: Date.now() };
  localStorage.setItem("examData", JSON.stringify(examData));
} else {
  // حساب الوقت المتبقي إذا بدأ الامتحان مسبقاً
  const elapsed = Math.floor((Date.now() - examData[currentUser.name].startTime)/1000);
  remainingTime = examDuration - elapsed;
  if(remainingTime <= 0){
    alert("انتهى وقت الامتحان!");
    examData[currentUser.name].taken = true;
    localStorage.setItem("examData", JSON.stringify(examData));
    window.location.href = "dashboard.html";
  }
}

// عداد الوقت
const timerEl = document.getElementById("timer");
const timerInterval = setInterval(()=>{
  let minutes = Math.floor(remainingTime/60);
  let seconds = remainingTime % 60;
  timerEl.innerText = `الوقت المتبقي: ${minutes} : ${seconds < 10 ? '0'+seconds : seconds}`;
  remainingTime--;
  if(remainingTime < 0){
    clearInterval(timerInterval);
    submitExam();
  }
}, 1000);

// منع العودة للصفحة بعد الخروج أو إعادة تحميل الصفحة
window.onbeforeunload = function() {
  examData[currentUser.name].taken = true;
  localStorage.setItem("examData", JSON.stringify(examData));
}

// معالجة التسليم وحفظ الدرجة
const grades = JSON.parse(localStorage.getItem("ziadGrades") || "{}");

document.getElementById("exam-form").addEventListener("submit", function(e){
  e.preventDefault();
  submitExam();
});

function submitExam(){
  if(examData[currentUser.name].taken) return;
  let total = 0;
  for(let i=1;i<=3;i++){
    const val = document.querySelector(`input[name="q${i}"]:checked`);
    if(val) total += parseInt(val.value);
  }
  grades[currentUser.name] = total;
  localStorage.setItem("ziadGrades", JSON.stringify(grades));
  examData[currentUser.name].taken = true;
  localStorage.setItem("examData", JSON.stringify(examData));
  alert(`تم تسليم الامتحان! درجتك: ${total}/3`);
  window.location.href = "dashboard.html";
}
</script>

</body>
</html>